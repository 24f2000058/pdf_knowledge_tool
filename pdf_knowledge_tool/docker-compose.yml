services:
  rag-app:
    build: .
    container_name: pdf-rag-app
    ports:
      - "8501:8501"
    volumes:
      # Persist RAG data (Vectors, Metadata, Images)
      - ./data:/app/data
      # Cache Hugging Face models to avoid re-downloading
      - hf_cache:/app/data/hf_cache
    environment:
      - PYTHONUNBUFFERED=1
      # Pass through environment variables (or define them here)
      - LLM_BACKEND=${LLM_BACKEND:-transformers}
      - MODEL_NAME=${MODEL_NAME:-Qwen/Qwen2.5-0.5B-Instruct}
      - MAX_CONTEXT_TOKENS=${MAX_CONTEXT_TOKENS:-2000}
      - ENABLE_PAGE_PREVIEWS=${ENABLE_PAGE_PREVIEWS:-true}
      - HF_HOME=/app/data/hf_cache
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    # Optional: Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 4G

volumes:
  hf_cache:
